<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>متتبع السوق اللحظي — 200 عملة</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{font-family:Arial,sans-serif;background:#111;color:#eee;text-align:center;padding:20px;}
    h1{color:#f44336;}
    .controls{margin-bottom:20px;}
    .controls select,.controls input,.controls button{padding:8px 15px;margin:5px;border:none;border-radius:5px;background:#333;color:#fff;cursor:pointer;}
    button.active{background:#f44336;}
    table{width:90%;margin:auto;border-collapse:collapse;}
    th,td{padding:10px;border-bottom:1px solid #333;}
    th:hover{background:#2a2a2a;}
    .up{color:#4caf50;}
    .down{color:#f44336;}
    .symbol{font-weight:bold;}
    .timestamp{font-size:0.9em;color:#aaa;}
    .sparkline{width:50px;height:25px;}
    .error{color:red;}
    [aria-sort="ascending"]::after{content:" ↑";}
    [aria-sort="descending"]::after{content:" ↓";}
  </style>
</head>
<body>
  <h1>📊 متتبع السوق اللحظي — (200 عملة)</h1>
  <div class="controls">
    <label>عتبة التغيير %:</label>
    <select id="threshold"><option>1%</option><option>3%</option><option selected>5%</option><option>10%</option></select>
    <input id="search" placeholder="ابحث عن عملة..." />
    <button onclick="setFilter('all')" class="active">الكل</button>
    <button onclick="setFilter('up')">صعود فقط</button>
    <button onclick="setFilter('down')">هبوط فقط</button>
    <button onclick="update()">🔄 تحديث الآن</button>
  </div>
  <div id="tracker">جارٍ التحميل...</div>

  <script>
    let coins = [], filter='all', sortCol='rank', sortOrder='asc';

    async function fetchData(){
      const url='https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=200&page=1&sparkline=true&price_change_percentage=24h';
      try {
        const resp=await fetch(url), data=await resp.json();
        return data.map(c=>({
          id:c.id, rank:c.market_cap_rank, name:c.name, symbol:c.symbol.toUpperCase(),
          price:c.current_price, change:c.price_change_percentage_24h,
          marketCap:c.market_cap, volume:c.total_volume,
          sparkline:c.sparkline_in_7d.price.slice(-24)
        }));
      } catch(e){document.getElementById('tracker').innerHTML=`<div class="error">خطأ: ${e.message}</div>`; return [];}
    }

    function renderSpark(id,data){
      const ctx=document.getElementById(id).getContext('2d');
      new Chart(ctx,{type:'line',data:{labels:Array(data.length),datasets:[{data,borderColor:data[data.length-1]>data[0]?'#4caf50':'#f44336',fill:false,pointRadius:0,borderWidth:1}]},
                   options:{responsive:true,maintainAspectRatio:false,scales:{x:{display:false},y:{display:false}},plugins:{legend:{display:false},tooltip:{enabled:false}}}});
    }

    function renderTable(){
      let T=coins.filter(c=>{
        if(filter==='up')return c.change>0;
        if(filter==='down')return c.change<0;
        return true;
      });
      const s=document.getElementById('search').value.toLowerCase();
      if(s)T=T.filter(c=>c.name.toLowerCase().includes(s)||c.symbol.toLowerCase().includes(s));
      const thr=+document.getElementById('threshold').value;
      T=T.filter(c=>Math.abs(c.change)>=thr);
      T.sort((a,b)=>(sortOrder==='asc'?a[sortCol]-b[sortCol]:b[sortCol]-a[sortCol]));
      if(!T.length){document.getElementById('tracker').innerHTML='<div class="error">لا توجد نتائج مطابقة</div>';return;}
      let html=`<div class="timestamp">آخر تحديث: ${new Date().toLocaleString('ar')}</div><table>
        <thead><tr>
          <th onclick="sort('rank')" aria-sort="${sortCol==='rank'?sortOrder:''}">#</th>
          <th onclick="sort('name')" aria-sort="${sortCol==='name'?sortOrder:''}">الاسم</th>
          <th onclick="sort('symbol')" aria-sort="${sortCol==='symbol'?sortOrder:''}">الرمز</th>
          <th onclick="sort('price')" aria-sort="${sortCol==='price'?sortOrder:''}">السعر</th>
          <th onclick="sort('change')" aria-sort="${sortCol==='change'?sortOrder:''}">تغيير 24س</th>
          <th onclick="sort('marketCap')" aria-sort="${sortCol==='marketCap'?sortOrder:''}">القيمة السوقية</th>
          <th onclick="sort('volume')" aria-sort="${sortCol==='volume'?sortOrder:''}">الحجم</th><th>📈</th>
        </tr></thead><tbody>`;
      T.forEach(c=>{
        html+=`<tr>
          <td>${c.rank}</td><td>${c.name}</td><td class="symbol">${c.symbol}</td>
          <td>${c.price.toFixed(2)}</td><td class="${c.change>=0?'up':'down'}">${c.change.toFixed(2)}%</td>
          <td>${(c.marketCap/1e9).toFixed(2)}B</td><td>${(c.volume/1e9).toFixed(2)}B</td>
          <td><canvas id="sp-${c.id}" class="sparkline"></canvas></td>
        </tr>`;
      });
      html+='</tbody></table>';
      document.getElementById('tracker').innerHTML=html;
      T.forEach(c=>renderSpark(`sp-${c.id}`, c.sparkline));
    }

    function sort(col){
      sortCol=col;
      sortOrder = (sortCol===col ? (sortOrder==='asc'?'desc':'asc') : 'asc');
      renderTable();
    }

    function setFilter(f){
      filter=f;
      document.querySelectorAll('.controls button').forEach(b=>b.classList.remove('active'));
      document.querySelector(`.controls button[onclick="setFilter('${f}')"]`).classList.add('active');
      renderTable();
    }

    async function update(){
      coins=await fetchData();
      renderTable();
    }

    document.getElementById('threshold').onchange=renderTable;
    document.getElementById('search').oninput=renderTable;

    update();
    setInterval(update, 30000);
  </script>
</body>
</html>
