<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…ØªØªØ¨Ø¹ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù„Ø­Ø¸ÙŠ - 200 Ø¹Ù…Ù„Ø©</title>
  <style>/* Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø³Ø§Ø¨Ù‚ */</style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>ğŸ“Š Ù…ØªØªØ¨Ø¹ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ù„Ø­Ø¸ÙŠ (200 Ø¹Ù…Ù„Ø©)</h1>
  <div class="controls">
    <div class="control-group">
      <label for="threshold">Ø¹ØªØ¨Ø© Ø§Ù„ØªØºÙŠÙŠØ± (%):</label>
      <select id="threshold"><option>1%</option><option>3%</option><option selected>5%</option><option>10%</option></select>
    </div>
    <div class="control-group">
      <input id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…Ù„Ø©...">
    </div>
    <div class="filter-btns">
      <button onclick="setFilter('all')" class="active">Ø§Ù„ÙƒÙ„</button>
      <button onclick="setFilter('up')">ØµØ¹ÙˆØ¯ ÙÙ‚Ø·</button>
      <button onclick="setFilter('down')">Ù‡Ø¨ÙˆØ· ÙÙ‚Ø·</button>
    </div>
    <button onclick="updateData()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù†</button>
  </div>
  <div id="tracker">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

  <script>
    let coinsData = [], filter = 'all', sortColumn='rank', sortOrder='asc';

    async function fetchData() {
      try {
        const resp = await fetch('https://api.coincap.io/v2/assets?limit=200');
        const data = await resp.json();
        return data.data.map(c => ({
          id: c.id, rank: +c.rank, name: c.name, symbol: c.symbol,
          price: +c.priceUsd, change: +c.changePercent24Hr,
          marketCap: +c.marketCapUsd, volume: +c.volumeUsd24Hr,
          sparkline: []
        }));
      } catch(e) {
        document.getElementById('tracker').innerHTML = `<div class="error">Ø®Ø·Ø£: ${e.message}</div>`;
        return [];
      }
    }

    async function fetchSparkline(id) {
      try {
        const resp = await fetch(`https://api.coincap.io/v2/assets/${id}/history?interval=h1`);
        const d = await resp.json();
        return d.data.slice(-24).map(x => +x.priceUsd);
      } catch { return []; }
    }

    function renderSparkline(canvasId, data) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      new Chart(ctx, {type:'line', data:{labels:Array(data.length), datasets:[{data, borderColor: data[data.length-1]>data[0]?'#4caf50':'#f44336', fill:false, pointRadius:0, borderWidth:1}]}, options:{responsive:true, scales:{x:{display:false},y:{display:false}}, plugins:{legend:{display:false},tooltip:{enabled:false}}}});
    }

    function renderTable(data) {
      let res = data.filter(c => filter==='all' || (filter==='up' && c.change>0) || (filter==='down' && c.change<0));
      const term = document.getElementById('search-input').value.toLowerCase();
      if(term) res = res.filter(c=>c.name.toLowerCase().includes(term)||c.symbol.toLowerCase().includes(term));
      const thr = +document.getElementById('threshold').value;
      res = res.filter(c=>Math.abs(c.change)>=thr);
      res.sort((a,b)=> sortOrder==='asc'? a[sortColumn]-b[sortColumn]: b[sortColumn]-a[sortColumn]);

      let html = `<table><thead><tr><th onclick="sortTable('rank')">#</th><th onclick="sortTable('name')">Ø§Ù„Ø§Ø³Ù…</th><th>Ø³Ø¹Ø±</th><th>24Ø³ %</th><th>Ù…Ø®Ø·Ø·</th></tr></thead><tbody>`;
      res.forEach(c => {
        html += `<tr><td>${c.rank}</td><td>${c.name} (${c.symbol})</td><td>${c.price.toFixed(2)}</td><td class="${c.change>=0?'up':'down'}">${c.change.toFixed(2)}%</td><td><canvas id="sp-${c.id}" class="sparkline"></canvas></td></tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById('tracker').innerHTML = `<div>Ø¢Ø®Ø±: ${new Date().toLocaleString('ar')}</div>` + html;
      res.forEach(c=> c.sparkline.length && renderSparkline(`sp-${c.id}`, c.sparkline));
    }

    async function updateData() {
      coinsData = await fetchData();
      await Promise.all(coinsData.map(async c=> c.sparkline = await fetchSparkline(c.id)));
      renderTable(coinsData);
    }

    function sortTable(col) {
      sortColumn = col;
      sortOrder = sortOrder==='asc'?'desc':'asc';
      renderTable(coinsData);
    }
    function setFilter(f) {
      filter = f;
      document.querySelectorAll('.filter-btns button').forEach(b=>b.classList.remove('active'));
      document.querySelector(`.filter-btns button[onclick="setFilter('${f}')"]`).classList.add('active');
      renderTable(coinsData);
    }

    document.getElementById('threshold').addEventListener('change', ()=>renderTable(coinsData));
    document.getElementById('search-input').addEventListener('input', ()=>renderTable(coinsData));

    updateData();
    setInterval(updateData, 30000);
  </script>
</body>
</html>
